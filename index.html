<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Anual - COMESOL</title>
    <!-- Carregamento do Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* light gray background */
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Estilos personalizados para o bot√£o principal */
        .btn-primary {
            background-color: #48bb78; /* green-500 */
            transition: background-color 0.3s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #38a169; /* green-600; */
        }
        .btn-primary:disabled {
            background-color: #a0aec0; /* gray-400 */
            cursor: not-allowed;
        }
        /* Estiliza o efeito de campo inv√°lido */
        input:invalid:not(:placeholder-shown), select:invalid:not(:placeholder-shown) {
            border-color: #f56565 !important; /* red-500 */
            box-shadow: 0 0 0 1px #f56565 !important;
        }
    </style>
</head>
<body>

<div id="app-container" class="min-h-screen p-4 sm:p-8 flex items-start justify-center">
    <div class="w-full max-w-4xl bg-white rounded-xl card p-6 sm:p-10 my-8">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Cadastro Anual - COMESOL</h1>
        <p class="text-sm text-gray-600 mb-6">Preencha as informa√ß√µes do grupo e, em seguida, adicione os dados de cada membro. N√£o √© necess√°rio fazer login!</p>

        <!-- Informa√ß√µes do Aplicativo/Status -->
        <div id="info-bar" class="text-xs mb-4 p-2 bg-gray-100 rounded-lg text-gray-500">
            <p>Backend: <span class="font-mono">Supabase</span></p>
            <p>Status de Conex√£o: <span id="db-status" class="font-semibold">Carregando...</span></p>
        </div>

        <form id="solidarity-group-form" onsubmit="event.preventDefault(); saveGroupData();">

            <!-- SE√á√ÉO 1: DADOS DO GRUPO -->
            <section id="group-data-section" class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20h-5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.592-.323-1.137-.833-1.432m0 0a3.001 3.001 0 00-5.334 0M12 20v-2c0-.592-.323-1.137-.833-1.432M12 20v-2a3.001 3.001 0 00-5.334 0M4 18h5v2H4V18z"></path></svg>
                    Informa√ß√µes do Grupo
                </h2>
                
                <div class="mb-4">
                    <label for="groupName" class="block text-sm font-medium text-gray-700">Nome do Grupo/Empreendimento *</label>
                    <input type="text" id="groupName" required oninput="updateMemberCountAndList()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                </div>
                
                <div class="mb-4">
                    <label for="groupRepresentativeName" class="block text-sm font-medium text-gray-700">Nome do representante *</label>
                    <input type="text" id="groupRepresentativeName" required oninput="updateMemberCountAndList()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                </div>

                <div class="mb-4">
                    <label for="groupContact" class="block text-sm font-medium text-gray-700">E-mail de Contato *</label>
                    <input type="email" id="groupContact" required oninput="updateMemberCountAndList()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border" placeholder="exemplo@dominio.com">
                </div>
            </section>

            <!-- SE√á√ÉO 2: DADOS DOS MEMBROS (Din√¢mico) -->
            <section class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Cadastro de Membros
                </h2>
                
                <!-- Formul√°rio de Adi√ß√£o de Membro (AGORA √â UM DIV PARA EVITAR ANINHAMENTO DE FORM) -->
                <div id="member-add-form" class="p-4 mb-4 border border-blue-300 rounded-lg bg-white">
                    <h3 class="font-semibold text-blue-700 mb-3">Adicionar Novo Membro</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        
                        <!-- Linha 1: Nome, Nascimento, CNPJ -->
                        <div class="lg:col-span-2"> <!-- Nome Completo -->
                            <label for="memberName" class="block text-xs font-medium text-gray-700">Nome Completo *</label>
                            <input type="text" id="memberName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        <div> <!-- Data de Nascimento -->
                            <label for="memberBirthDate" class="block text-xs font-medium text-gray-700">Data de Nascimento *</label>
                            <input type="date" id="memberBirthDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        
                        <!-- Linha 2: Nome da M√£e (Full width) -->
                        <div class="lg:col-span-3">
                            <label for="memberMothersName" class="block text-xs font-medium text-gray-700">Nome Completo da M√£e *</label>
                            <input type="text" id="memberMothersName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        
                        <!-- Linha 3: Endere√ßo / CEP -->
                        <div class="lg:col-span-2"> <!-- Endere√ßo Completo -->
                            <label for="memberAddress" class="block text-xs font-medium text-gray-700">Endere√ßo Completo (Rua, N¬∫, Bairro) *</label>
                            <input type="text" id="memberAddress" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        <div> <!-- CEP -->
                            <label for="memberCEP" class="block text-xs font-medium text-gray-700">CEP *</label>
                            <input type="text" id="memberCEP" required placeholder="Ex: 00000-000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>

                        <!-- Linha 4: Contato / E-mail -->
                        <div> <!-- Celular -->
                            <label for="memberPhone" class="block text-xs font-medium text-gray-700">Celular *</label>
                            <input type="tel" id="memberPhone" required placeholder="Ex: (99) 99999-9999" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        <div class="lg:col-span-2"> <!-- E-mail -->
                            <label for="memberEmail" class="block text-xs font-medium text-gray-700">E-mail *</label>
                            <input type="email" id="memberEmail" required placeholder="exemplo@dominio.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>

                        <!-- Linha 5: Documentos / CNPJ -->
                        <div> <!-- RG -->
                            <label for="memberRG" class="block text-xs font-medium text-gray-700">RG *</label>
                            <input type="text" id="memberRG" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        <div> <!-- CPF -->
                            <label for="memberCPF" class="block text-xs font-medium text-gray-700">CPF *</label>
                            <input type="text" id="memberCPF" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        <div> <!-- MEI/CNPJ (N√£o Obrigat√≥rio) -->
                            <label for="memberCNPJ" class="block text-xs font-medium text-gray-700">MEI/CNPJ</label>
                            <input type="text" id="memberCNPJ" placeholder="Opcional" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>

                        <!-- SE√á√ÉO: DADOS DEMOGR√ÅFICOS -->
                        <div class="lg:col-span-3 pt-4 border-t border-blue-100">
                             <h4 class="font-semibold text-sm text-gray-700 mb-2">Dados Demogr√°ficos e Sociais</h4>
                        </div>
                        <div> <!-- G√™nero -->
                            <label for="memberGender" class="block text-xs font-medium text-gray-700">G√™nero *</label>
                            <select id="memberGender" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                                <option value="" disabled selected>Selecione</option>
                                <option value="Mulher cisg√™nero">Mulher cisg√™nero</option>
                                <option value="Homem cisg√™nero">Homem cisg√™nero</option>
                                <option value="Mulher transg√™nero">Mulher transg√™nero</option>
                                <option value="Homem transg√™nero">Homem transg√™nero</option>
                                <option value="N√£o-Bin√°rio">N√£o-Bin√°rio</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div> <!-- Etnia -->
                            <label for="memberEthnicity" class="block text-xs font-medium text-gray-700">Etnia / Cor *</label>
                            <select id="memberEthnicity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                                <option value="" disabled selected>Selecione</option>
                                <option value="Branca">Branca</option>
                                <option value="Preta">Preta</option>
                            <option value="Parda">Parda</option>
                                <option value="Amarela">Amarela</option>
                                <option value="Ind√≠gena">Ind√≠gena</option>
                            </select>
                        </div>
                        <div> <!-- Escolaridade -->
                            <label for="memberEducation" class="block text-xs font-medium text-gray-700">Escolaridade *</label>
                            <select id="memberEducation" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                                <option value="" disabled selected>Selecione</option>
                                <option value="Analfabeto">Analfabeto</option>
                                <option value="Ensino Fundamental Incompleto">Fundamental Incompleto</option>
                                <option value="Ensino Fundamental Completo">Fundamental Completo</option>
                                <option value="Ensino M√©dio Incompleto">M√©dio Incompleto</option>
                                <option value="Ensino M√©dio Completo">M√©dio Completo</option>
                                <option value="Ensino Superior Incompleto">Superior Incompleto</option>
                                <option value="Ensino Superior Completo">Superior Completo</option>
                                <option value="P√≥s-gradua√ß√£o/Mestrado/Doutorado">P√≥s-gradua√ß√£o ou mais</option>
                            </select>
                        </div>
                        
                        <!-- Novo campo: Quantas pessoas mora na sua casa? -->
                        <div> 
                            <label for="memberHouseholdSize" class="block text-xs font-medium text-gray-700">Quantas pessoas mora na sua casa? *</label>
                            <input type="number" id="memberHouseholdSize" required min="1" placeholder="N¬∫ de Pessoas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>


                        <!-- SE√á√ÉO: DADOS DO EMPREENDIMENTO E RENDA -->
                        <div class="lg:col-span-3 pt-4 border-t border-blue-100">
                             <h4 class="font-semibold text-sm text-gray-700 mb-2">Dados do Empreendimento e Renda</h4>
                        </div>
                        
                        <div class="lg:col-span-3"> <!-- Novo campo: Qual sua fun√ß√£o dentro do grupo? -->
                            <label for="memberRole" class="block text-xs font-medium text-gray-700">Qual sua fun√ß√£o dentro do grupo? (Ex: Coordenador, Produ√ß√£o, Financeiro) *</label>
                            <input type="text" id="memberRole" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>

                        <div class="lg:col-span-3"> <!-- Novo campo: Quais produtos ou servi√ßo oferece? -->
                            <label for="memberProducts" class="block text-xs font-medium text-gray-700">Quais produtos ou servi√ßo oferece? *</label>
                            <input type="text" id="memberProducts" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>

                        <div class="lg:col-span-3"> <!-- Novo campo: Quais mat√©rias primas utiliza? -->
                            <label for="memberRawMaterials" class="block text-xs font-medium text-gray-700">Quais mat√©rias primas utiliza? *</label>
                            <input type="text" id="memberRawMaterials" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        
                        <div class="lg:col-span-2"> <!-- Novo campo: Qual a renda m√©dia mensal obtida no empreendimento? -->
                            <label for="memberMonthlyIncome" class="block text-xs font-medium text-gray-700">Qual a renda m√©dia mensal obtida no empreendimento? *</label>
                            <select id="memberMonthlyIncome" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                                <option value="" disabled selected>Selecione a faixa de Sal√°rio M√≠nimo (SM)</option>
                                <option value="Ate 1 SM">At√© 1 SM</option>
                                <option value="Mais de 1 SM ate 2 SM">Mais de 1 SM at√© 2 SM</option>
                                <option value="Mais de 2 SM ate 3 SM">Mais de 2 SM at√© 3 SM</option>
                                <option value="Mais de 3 SM ate 5 SM">Mais de 3 SM at√© 5 SM</option>
                                <option value="Acima de 5 SM">Acima de 5 SM</option>
                            </select>
                        </div>
                        
                        <div class="lg:col-span-3"> <!-- Novo campo: Qual seu envolvimento com o movimento da Economia Solid√°ria? -->
                            <label for="memberSolidarityInvolvement" class="block text-xs font-medium text-gray-700">Qual seu envolvimento com o movimento da Economia Solid√°ria? *</label>
                            <input type="text" id="memberSolidarityInvolvement" required placeholder="Ex: Participa de feiras, conselhos, forma√ß√µes, etc." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>

                        <!-- Campos Condicionais de Atividade Econ√¥mica -->
                        <div class="lg:col-span-3"> <!-- Novo campo: Desenvolve outra atividade econ√¥mica? (Toggle) -->
                            <label for="memberOtherActivityToggle" class="block text-xs font-medium text-gray-700">Desenvolve outra atividade econ√¥mica al√©m do empreendimento? *</label>
                            <select id="memberOtherActivityToggle" required onchange="toggleOtherActivityField()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                                <option value="" disabled selected>Selecione</option>
                                <option value="Sim">Sim</option>
                                <option value="N√£o">N√£o</option>
                            </select>
                        </div>
                        <div id="memberOtherActivityField" class="lg:col-span-3 hidden">
                            <label for="memberOtherActivity" class="block text-xs font-medium text-gray-700">Qual atividade? *</label>
                            <!-- O atributo 'required' √© manipulado via JS em toggleOtherActivityField() -->
                            <input type="text" id="memberOtherActivity" placeholder="Ex: Professor(a), Motorista de App, etc." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>

                        <!-- Linha Final: Bot√£o de Adicionar -->
                        <div class="col-span-full pt-4">
                            <!-- type="button" e onclick direto para evitar que este bot√£o submeta o FORM principal -->
                            <button type="button" onclick="addMember()" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition text-sm font-semibold">
                                + Adicionar Membro
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de Membros Adicionados -->
                <h3 class="font-semibold text-gray-700 mb-3 mt-6">Membros Cadastrados (<span id="member-count">0</span>)</h3>
                <div id="member-list-container" class="space-y-3">
                    <!-- Membros ser√£o injetados aqui -->
                </div>
            </section>

            <!-- SE√á√ÉO 3: BOT√ÉO SALVAR E FEEDBACK -->
            <div class="flex flex-col sm:flex-row justify-between items-center pt-6 border-t">
                <p id="save-status" class="text-sm text-gray-600 mb-4 sm:mb-0">‚ö†Ô∏è √â necess√°rio preencher as informa√ß√µes do grupo e adicionar membros para habilitar o bot√£o.</p>
                <button type="submit" id="save-button" class="btn-primary text-white py-3 px-8 rounded-full font-bold shadow-lg hover:shadow-xl transition duration-200 flex items-center justify-center" disabled>
                    <svg id="save-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-4 5l4-4m0 0l4 4m-4-4v12"></path></svg>
                    Salvar Cadastro do Grupo
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Alerta Customizado -->
<div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg max-w-sm w-full mx-4 shadow-2xl">
        <h3 id="alert-title" class="text-lg font-bold mb-3 text-red-600">Alerta</h3>
        <p id="alert-message" class="text-gray-700 mb-4"></p>
        <div class="flex justify-end">
            <button onclick="closeCustomAlert()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition">Entendi</button>
        </div>
    </div>
</div>

<!-- Supabase SDK e L√≥gica da Aplica√ß√£o -->
<script type="module">
    // Importa√ß√£o do Supabase
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/+esm';

    // =========================================================================================
    // ‚ö†Ô∏è ATEN√á√ÉO: √â OBRIGAT√ìRIO PREENCHER CORRETAMENTE A URL e CHAVE ANON (PUBLIC) ‚ö†Ô∏è
    // =========================================================================================
    const SUPABASE_URL = 'https://egarccprmvgqsvivnerc.supabase.co'; 
    // Por favor, substitua a chave abaixo (come√ßa com eyJ) pela sua chave real 'anon public' do Supabase.
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnYXJjY3BybXZncXN2aXZuZXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjU0NTksImV4cCI6MjA3NDc0MTQ1OX0.Q_fdoeRnHx52EFOHIqk_icwe6auXDmmmLeJ266mSzEw'; // <---- Substitua este valor!
    const SUPABASE_TABLE_NAME = 'solidarity_economy_groups'; // Nome da sua tabela

    // Vari√°veis globais
    let supabase = null;
    let members = []; // Estado local para os membros do grupo

    // Fun√ß√µes de Utilidade (Dispon√≠veis globalmente)
    window.addMember = addMember;
    window.removeMember = removeMember;
    window.saveGroupData = saveGroupData;
    window.customAlert = customAlert;
    window.closeCustomAlert = closeCustomAlert;
    window.toggleOtherActivityField = toggleOtherActivityField;
    window.updateMemberCountAndList = updateMemberCountAndList; 
    
    /**
     * Verifica a validade APENAS dos campos da se√ß√£o "Informa√ß√µes do Grupo".
     * @returns {boolean} True se todos os campos de grupo estiverem v√°lidos e preenchidos.
     */
    function checkGroupFieldsValidity() {
        const nameInput = document.getElementById('groupName');
        const representativeInput = document.getElementById('groupRepresentativeName');
        const contactInput = document.getElementById('groupContact');
        
        // Verifica se os elementos existem e se a validade nativa do HTML √© true
        const isNameValid = nameInput ? nameInput.checkValidity() : false;
        const isRepresentativeValid = representativeInput ? representativeInput.checkValidity() : false;
        const isContactValid = contactInput ? contactInput.checkValidity() : false;

        return isNameValid && isRepresentativeValid && isContactValid;
    }


    // --- FUN√á√ïES DE UTILDADE DO UI ---

    function customAlert(title, message, isError = true) {
        const modal = document.getElementById('custom-alert-modal');
        const titleElement = document.getElementById('alert-title');
        const messageElement = document.getElementById('alert-message');

        if (!modal || !titleElement || !messageElement) {
            console.error(`Falha ao exibir alerta: ${title} - ${message}. Um ou mais elementos do modal n√£o foram encontrados no DOM.`);
            document.getElementById('save-status').textContent = `[ERRO DE UI] ${title}: ${message}`;
            return;
        }

        titleElement.textContent = title;
        messageElement.textContent = message;
        // Atualiza a classe de cor da borda/t√≠tulo
        titleElement.className = isError ? 'text-lg font-bold mb-3 text-red-600' : 'text-lg font-bold mb-3 text-green-600';
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeCustomAlert() {
        const modal = document.getElementById('custom-alert-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    function setLoading(isLoading) {
        const button = document.getElementById('save-button');
        
        if (!button) return; 

        button.disabled = isLoading;

        if (isLoading) {
            button.classList.add('bg-opacity-70');
            // Substitui o conte√∫do do bot√£o por um spinner e texto "Salvando..."
            button.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Salvando...`;
        } else {
            button.classList.remove('bg-opacity-70');
            // Restaura o √≠cone original e texto e reavalia a UI (CR√çTICO)
            button.innerHTML = `<svg id="save-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-4 5l4-4m0 0l4 4m-4-4v12"></path></svg> Salvar Cadastro do Grupo`;
            updateMemberCountAndList();
        }
    }

    /**
     * Atualiza a contagem e a lista de membros, e verifica as condi√ß√µes para habilitar o bot√£o de salvar.
     */
    function updateMemberCountAndList() {
        const memberCountElement = document.getElementById('member-count');
        const listContainer = document.getElementById('member-list-container');
        const saveButton = document.getElementById('save-button');
        const saveStatus = document.getElementById('save-status');

        if (!memberCountElement || !listContainer || !saveButton || !saveStatus) {
            console.warn("Elementos do UI n√£o encontrados. Pulando atualiza√ß√£o.");
            return;
        }
        
        // 1. ATUALIZA√á√ÉO DO CONTADOR
        memberCountElement.textContent = members.length;
        listContainer.innerHTML = ''; // Limpa a lista para reconstruir
        
        // 2. VERIFICA√á√ÉO DE VALIDADE
        const isSupabaseReady = supabase !== null;
        // Usa a fun√ß√£o de valida√ß√£o isolada para evitar campos de membro vazios
        const isGroupDataValid = checkGroupFieldsValidity(); 
        
        const canSave = isGroupDataValid && members.length > 0 && isSupabaseReady;
        
        // 3. L√ìGICA DE HABILITA√á√ÉO DO BOT√ÉO E MENSAGEM DE STATUS
        saveButton.disabled = !canSave;
        
        if (!isSupabaseReady) {
            saveStatus.textContent = '‚ö†Ô∏è ERRO DE CONFIGURA√á√ÉO: O Supabase n√£o est√° pronto. Preencha a URL e a Chave Anon.';
            saveButton.disabled = true; 
        } else if (members.length === 0) {
             saveStatus.textContent = '√â necess√°rio adicionar pelo menos um membro para salvar o grupo.';
        } else if (!isGroupDataValid) {
            saveStatus.textContent = '‚ö†Ô∏è Preencha todos os campos obrigat√≥rios das Informa√ß√µes do Grupo (acima) para habilitar o salvamento.';
        } else { // canSave is true
            saveStatus.textContent = '‚úÖ Pronto para salvar! Clique no bot√£o Salvar Cadastro do Grupo.';
        }
        
        // 4. ATUALIZA√á√ÉO DA LISTA VISUAL
        if (members.length === 0) {
            const noMembersMessage = `
                <p id="no-members-message" class="text-sm text-gray-500 p-4 border rounded-md bg-white">
                    Nenhum membro adicionado ainda. Use o formul√°rio acima para come√ßar.
                </p>
            `;
            listContainer.innerHTML = noMembersMessage;
        } else {
            members.forEach((member, index) => {
                // Formata a data de nascimento para exibi√ß√£o (DD/MM/AAAA). Timezone UTC para evitar problemas de fuso.
                const formattedBirthDate = new Date(member.birthDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                
                const memberCard = `
                    <div class="p-4 border rounded-lg bg-white flex justify-between items-center transition hover:bg-gray-50">
                        <div class="flex-grow min-w-0">
                            <p class="font-semibold text-gray-800 truncate">${member.name} (ID: ${index + 1})</p>
                            <p class="text-xs text-gray-600 truncate">
                                M√£e: ${member.mothersName} | Nasc.: ${formattedBirthDate}
                            </p>
                            <p class="text-xs text-gray-500 space-x-2 truncate mt-1">
                                <span>CPF: ${member.cpf}</span> |
                                <span>Celular: ${member.phone}</span> |
                                <span>Fun√ß√£o: ${member.memberRole}</span>
                            </p>
                        </div>
                        <button type="button" onclick="removeMember(${index})" class="ml-4 text-red-500 hover:text-red-700 p-2 rounded-full transition bg-red-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', memberCard);
            });
        }
    }

    // --- L√ìGICA DE MEMBROS ---

    function toggleOtherActivityField() {
        const toggleElement = document.getElementById('memberOtherActivityToggle');
        const fieldContainer = document.getElementById('memberOtherActivityField');
        const otherActivityInput = document.getElementById('memberOtherActivity');
        
        if (!toggleElement || !fieldContainer || !otherActivityInput) return;

        const toggle = toggleElement.value;
        
        if (toggle === 'Sim') {
            fieldContainer.classList.remove('hidden');
            otherActivityInput.setAttribute('required', 'required'); // Torna o campo obrigat√≥rio
        } else {
            fieldContainer.classList.add('hidden');
            otherActivityInput.removeAttribute('required'); // Remove a obrigatoriedade
            otherActivityInput.value = ''; // Limpa o valor se o campo for escondido
        }
    }

    /**
     * Adiciona o membro.
     */
    function addMember() {
        // Lista de IDs dos campos obrigat√≥rios (incluindo o condicional se for 'Sim')
        const requiredFieldIds = [
            'memberName', 'memberBirthDate', 'memberMothersName', 
            'memberAddress', 'memberCEP', 'memberPhone', 'memberEmail', 
            'memberRG', 'memberCPF', 'memberGender', 'memberEthnicity', 
            'memberEducation', 'memberHouseholdSize', 'memberRole', 
            'memberProducts', 'memberRawMaterials', 'memberMonthlyIncome',
            'memberSolidarityInvolvement', 'memberOtherActivityToggle'
        ];

        let isFormValid = true;
        let firstInvalidElement = null;

        // 1. Valida√ß√£o dos campos obrigat√≥rios fixos 
        for (const id of requiredFieldIds) {
            const input = document.getElementById(id);
            if (input && !input.checkValidity()) {
                if (!firstInvalidElement) firstInvalidElement = input;
                isFormValid = false;
            }
        }
        
        // 2. Valida√ß√£o do campo condicional
        const otherActivityToggle = document.getElementById('memberOtherActivityToggle')?.value;
        const otherActivityInput = document.getElementById('memberOtherActivity');
        
        if (isFormValid && otherActivityToggle === 'Sim' && otherActivityInput) {
            if (!otherActivityInput.checkValidity()) {
                if (!firstInvalidElement) firstInvalidElement = otherActivityInput;
                isFormValid = false;
            }
        }

        if (!isFormValid) {
            // Reporta a validade no primeiro elemento inv√°lido
            if (firstInvalidElement) firstInvalidElement.reportValidity();
            return; // Interrompe a fun√ß√£o se a valida√ß√£o falhar
        }


        // 3. Coleta e valida√ß√£o num√©rica extra
        const householdSize = document.getElementById('memberHouseholdSize')?.value.trim();
        const size = parseInt(householdSize);
        if (size <= 0 || isNaN(size)) {
             customAlert("Campo Inv√°lido", "O campo 'Quantas pessoas mora na sua casa?' deve ser um n√∫mero inteiro maior que zero.", true);
             document.getElementById('memberHouseholdSize')?.reportValidity();
             return;
        }

        // 4. Coleta dos campos 
        const name = document.getElementById('memberName')?.value.trim();
        const birthDate = document.getElementById('memberBirthDate')?.value;
        const mothersName = document.getElementById('memberMothersName')?.value.trim();
        const address = document.getElementById('memberAddress')?.value.trim();
        const cep = document.getElementById('memberCEP')?.value.trim();
        const phone = document.getElementById('memberPhone')?.value.trim();
        const email = document.getElementById('memberEmail')?.value.trim();
        const rg = document.getElementById('memberRG')?.value.trim();
        const cpf = document.getElementById('memberCPF')?.value.trim();
        const cnpj = document.getElementById('memberCNPJ')?.value.trim(); 
        
        const education = document.getElementById('memberEducation')?.value;
        const gender = document.getElementById('memberGender')?.value;
        const ethnicity = document.getElementById('memberEthnicity')?.value;

        const memberRole = document.getElementById('memberRole')?.value.trim();
        const memberProducts = document.getElementById('memberProducts')?.value.trim();
        const memberRawMaterials = document.getElementById('memberRawMaterials')?.value.trim();
        const monthlyIncome = document.getElementById('memberMonthlyIncome')?.value;
        const solidarityInvolvement = document.getElementById('memberSolidarityInvolvement')?.value.trim();
        const otherActivity = otherActivityInput ? otherActivityInput.value.trim() : '';
        
        if (!name || !cpf || !email) {
            customAlert("Erro Interno de Campo", "Um campo cr√≠tico necess√°rio est√° ausente. Verifique os IDs do HTML.", true);
            return;
        }


        const newMember = {
            // Dados Pessoais
            name,
            birthDate,
            mothersName,
            address,
            cep,
            phone,
            email,
            rg,
            cpf,
            cnpj: cnpj || null, 

            // Dados Demogr√°ficos e Sociais
            education,
            gender,
            ethnicity,
            householdSize: size,

            // Dados do Empreendimento e Renda
            memberRole,
            memberProducts,
            memberRawMaterials,
            monthlyIncome,
            solidarityInvolvement,
            otherActivityToggle,
            otherActivity: otherActivityToggle === 'Sim' ? otherActivity : 'Nenhuma',
        };
        members.push(newMember);
        
        console.log(`Membro adicionado: ${newMember.name}. Total de membros: ${members.length}`); 

        // 5. Limpa os campos do DIV de adi√ß√£o de membro
        const inputsToClear = document.querySelectorAll('#member-add-form input, #member-add-form select');
        inputsToClear.forEach(input => {
            if (input.type !== 'submit' && input.type !== 'button') {
                if (input.tagName === 'SELECT') {
                    input.value = ''; 
                } else {
                    input.value = '';
                }
            }
        });

        // 6. Assegura que o campo condicional 'Outra Atividade' seja escondido e n√£o obrigat√≥rio
        const memberOtherActivityToggleEl = document.getElementById('memberOtherActivityToggle');
        if (memberOtherActivityToggleEl) memberOtherActivityToggleEl.value = ''; 
        
        document.getElementById('memberOtherActivityField')?.classList.add('hidden');
        if (otherActivityInput) {
             otherActivityInput.removeAttribute('required');
        }

        // Atualiza a lista visual e reavalia a habilita√ß√£o do bot√£o!
        updateMemberCountAndList(); 
        
        const saveStatus = document.getElementById('save-status');
        if (saveStatus) {
            saveStatus.textContent = `Membro ${name} adicionado com sucesso! Agora, preencha os dados do grupo (acima) para salvar.`;
        }
    }

    function removeMember(index) {
        if (index >= 0 && index < members.length) {
            const removedName = members[index].name;
            members.splice(index, 1);
            // Atualiza a lista visual e reavalia a habilita√ß√£o do bot√£o!
            updateMemberCountAndList(); 
            const saveStatus = document.getElementById('save-status');
            if (saveStatus) {
                saveStatus.textContent = `Membro ${removedName} removido.`;
            }
        }
    }

    // --- L√ìGICA DO SUPABASE E SALVAMENTO ---

    /**
     * Inicializa o cliente Supabase.
     */
    function initSupabase() {
        members = []; 

        const dbStatus = document.getElementById('db-status');
        if (!dbStatus) {
             console.error("Elemento 'db-status' n√£o encontrado.");
        }

        if (SUPABASE_ANON_KEY.includes("SUA_CHAVE_ANON_PUBLIC_AQUI")) {
            const errorMessage = "‚ùå ERRO FATAL: Configura√ß√£o Supabase ausente. Preencha o placeholder SUPABASE_ANON_KEY no c√≥digo-fonte.";
            console.error(errorMessage);
            if(dbStatus) dbStatus.textContent = 'Configura√ß√£o Ausente';
            
            supabase = null; 
            updateMemberCountAndList(); 
            return;
        }
        
        try {
            // Log para debug
            console.log(`[Supabase Debug] Conectando a URL: ${SUPABASE_URL}`);
            console.log(`[Supabase Debug] Usando chave ANON (verifique se come√ßa com 'eyJ'): ${SUPABASE_ANON_KEY.substring(0, 10)}...`);

            // 1. Inicializa o cliente Supabase
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            if(dbStatus) dbStatus.textContent = '‚úÖ Conectado ao Supabase';
            updateMemberCountAndList(); 

        } catch (error) {
            console.error("Erro ao inicializar Supabase:", error);
            customAlert("Erro no Supabase", `Falha ao iniciar o cliente: ${error.message}. Verifique sua URL e Chave Anon.`, true);
            if(dbStatus) dbStatus.textContent = 'Erro na Inicializa√ß√£o';
            supabase = null;
            updateMemberCountAndList(); 
        }
    }
    
    // Fun√ß√£o principal para salvar o grupo
    async function saveGroupData() {
        // Valida√ß√µes de UI e estado (RLS √© tratado no Supabase)
        if (!checkGroupFieldsValidity()) {
            document.getElementById('groupName')?.reportValidity();
            document.getElementById('groupRepresentativeName')?.reportValidity();
            document.getElementById('groupContact')?.reportValidity(); 
            customAlert("Dados Incompletos", "Por favor, preencha todos os campos obrigat√≥rios nas **Informa√ß√µes do Grupo**.", true);
            return;
        }
        
        if (supabase === null || members.length === 0) {
            customAlert("A√ß√£o Inv√°lida", "Verifique a conex√£o com o Supabase e se h√° membros adicionados.", true);
            return;
        }

        setLoading(true);
        const saveStatus = document.getElementById('save-status');
        if (saveStatus) saveStatus.textContent = 'Preparando para salvar...';

        const groupName = document.getElementById('groupName')?.value.trim();
        const groupContact = document.getElementById('groupContact')?.value.trim();
        const groupRepresentativeName = document.getElementById('groupRepresentativeName')?.value.trim(); 
        
        // Estrutura de dados para o Supabase
        const groupData = {
            group_name: groupName,
            group_representative_name: groupRepresentativeName, 
            group_contact: groupContact,
            members_count: members.length,
            // Armazena todos os dados do grupo e membros em um objeto JSON
            submission_data: JSON.stringify({
                group_contact: groupContact,
                members: members,
                submission_date: new Date().toISOString()
            })
        };

        try {
            // Insere os dados na tabela Supabase
            const { data, error } = await supabase
                .from(SUPABASE_TABLE_NAME)
                .insert([groupData])
                .select();
            
            if (error) throw error;
            
            const documentId = data[0].id; 

            if (saveStatus) saveStatus.textContent = `üéâ Sucesso! Grupo "${groupName}" salvo com ID ${documentId}.`;
            customAlert("Salvo com Sucesso", `O cadastro do grupo "${groupName}" foi salvo no Supabase! ID: ${documentId}`, false);
            
            // Limpa o formul√°rio principal e o estado ap√≥s o sucesso
            document.getElementById('solidarity-group-form').reset();
            members = [];
            
            updateMemberCountAndList(); 

        } catch (error) {
            console.error("Erro ao salvar dados do grupo no Supabase:", error);
            if (saveStatus) saveStatus.textContent = '‚ùå Erro ao salvar dados. Verifique a consola.';
            // Mensagem de erro aprimorada para o RLS
            customAlert(
                "Erro de Permiss√£o (RLS)", 
                `Ocorreu um erro ao salvar no Supabase: ${error.message}. Isso significa que sua chave ANON pode estar incorreta ou a pol√≠tica RLS n√£o est√° ativa para o INSERT. Por favor, verifique a chave e a pol√≠tica de RLS.`, 
                true
            );
        } finally {
            setLoading(false);
        }
    }

    // Inicializa o Supabase ao carregar a janela
    window.onload = initSupabase;
</script>
</body>
</html>
